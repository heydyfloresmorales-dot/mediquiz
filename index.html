<script>
async function testConnection() {
    const sheetsUrl = document.getElementById('sheetsUrl').value.trim();
    const gasUrl = document.getElementById('gasUrl').value.trim();
    
    if (!sheetsUrl || !gasUrl) {
        alert('Por favor ingresa ambas URLs');
        return;
    }

    const testBtn = document.querySelector('button[onclick="testConnection()"]');
    const testBtnText = document.getElementById('testBtnText');
    const testLoading = document.getElementById('testLoading');
    
    testBtn.disabled = true;
    testBtnText.style.display = 'none';
    testLoading.classList.remove('hidden');
    
    log('Probando conexión con Google Apps Script...');

    try {
        // Extraer ID del Sheets si es URL completa
        const sheetsId = extractSheetsId(sheetsUrl);

        // Probar conexión con Google Apps Script (GET)
        const response = await fetch(gasUrl);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();

        if (data.success) {
            sheetsConnected = true;
            systemData.sheetsId = sheetsId;
            systemData.gasUrl = gasUrl;

            // Guardar configuración
            localStorage.setItem('mediquiz_config', JSON.stringify({
                sheetsId: sheetsId,
                gasUrl: gasUrl
            }));

            updateStatusCard('sheetsStatus', 'success', 'Google Sheets', 'Conectado correctamente');
            log(`✅ Conexión exitosa: ${data.message}`);

            // Si el script devuelve metadata opcional
            if (data.metadata) {
                systemData.totalQuestions = data.metadata.totalQuestions || 0;
                systemData.specialties = data.metadata.specialties || [];
                updateSystemInfo();
            }
        } else {
            throw new Error(data.error || 'Respuesta inválida');
        }

    } catch (error) {
        sheetsConnected = false;
        updateStatusCard('sheetsStatus', 'error', 'Google Sheets', `Error: ${error.message}`);
        log(`❌ Error de conexión: ${error.message}`);
    }

    testBtn.disabled = false;
    testBtnText.style.display = 'inline';
    testLoading.classList.add('hidden');
    
    updateConnectionStatus();
    updateUI();
}
</script>

    
    
    
    

  
